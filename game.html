<!DOCTYPE html>

<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Cyberpunk Race Module</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&amp;family=Noto+Sans:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <!-- Material Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <!-- Three.js Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Tailwind Config -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "primary-glow": "#2f72f5",
                        "background-light": "#f6f6f8",
                        "background-dark": "#0a0a10", // Deepened for contrast
                        "surface": "#111318",
                        "surface-highlight": "#1e222b",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"],
                    },
                    backgroundImage: {
                        'grid-pattern': "linear-gradient(to right, #282e39 1px, transparent 1px), linear-gradient(to bottom, #282e39 1px, transparent 1px)",
                    }
                },
            },
        }
    </script>
    <style>
        /* Custom Scanline Effect */
        .scanlines {
            background: linear-gradient(to bottom,
                    rgba(255, 255, 255, 0),
                    rgba(255, 255, 255, 0) 50%,
                    rgba(0, 0, 0, 0.2) 50%,
                    rgba(0, 0, 0, 0.2));
            background-size: 100% 4px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 50;
        }

        /* Subtle pulsating glow animation */
        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(19, 91, 236, 0.2);
            }

            50% {
                box-shadow: 0 0 20px rgba(19, 91, 236, 0.5);
            }
        }

        .animate-pulse-glow {
            animation: pulse-glow 3s infinite;
        }

        /* Glassmorphism utility */
        .glass-panel {
            background: rgba(17, 19, 24, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 67, 84, 0.5);
        }
    </style>
</head>

<body
    class="bg-background-dark text-white font-display overflow-hidden h-screen w-screen selection:bg-primary selection:text-white">
    <!-- Game Viewport Container -->
    <div class="relative w-full h-full flex flex-col group/design-root">
        <!-- 3D Simulation Background (Placeholder for Three.js Canvas) -->
        <div id="static-bg" class="absolute inset-0 z-0 bg-[#050505]">
            <!-- Decorative Grid Floor for Simulation Look -->
            <div class="absolute inset-0 opacity-20"
                style="background-image: linear-gradient(#135bec 1px, transparent 1px), linear-gradient(90deg, #135bec 1px, transparent 1px); background-size: 40px 40px; transform: perspective(500px) rotateX(60deg) scale(2); transform-origin: center bottom;">
            </div>
            <!-- Background Image mimicking the game scene -->
            <img alt="Game Background" class="absolute inset-0 w-full h-full object-cover mix-blend-overlay opacity-60"
                data-alt="Futuristic cyberpunk neon city highway at night with perspective view"
                src="https://lh3.googleusercontent.com/aida-public/AB6AXuDBfKrvEF5C_dk0qLvg7xH0Fmbn5PY4KTKpHWLd-6JVtvFcPYi55qU0ikwsWpS9t4RG9Mik65ZGmGLq7cSQ0wXTEwsW9P_Kno_qf8LllFNspRJyxVq5t0uJeBHvkiadSrOk0PdwfLkEnQp5tuGyDdM7ZdkKvMkjI9PmBgfrswJITAzcIyTalHEvscWMnPN66b1AZs4lsfcVEMH6_ULJBB5q2hKvfKJs5tieJphl3pJCL8ONBEEQZovDJBWcCMkMMixGp8w2Y0tfdvI" />
            <!-- Vignette -->
            <div
                class="absolute inset-0 bg-radial-gradient from-transparent via-background-dark/40 to-background-dark/90 pointer-events-none">
            </div>
        </div>
        <!-- AR Video Feed (Initially Hidden) -->
        <video id="ar-feed" class="absolute inset-0 w-full h-full object-cover z-0 hidden" autoplay playsinline
            muted></video>
        <!-- Background Music -->
        <audio id="bg-music" loop>
            <source src="music/music1.mp3" type="audio/mpeg">
        </audio>
        <!-- Game Canvas Container -->
        <div id="game-container" class="absolute inset-0 z-20 pointer-events-none hidden"></div>
        <!-- Scanline Overlay -->
        <div class="scanlines"></div>
        <!-- UI Layer (HUD) -->
        <div class="relative z-10 flex flex-col h-full w-full p-4 md:p-8 pointer-events-none">
            <!-- Top HUD: Header & Stats -->
            <header
                class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 w-full pointer-events-auto">
                <!-- Module Identifier -->
                <!-- Score HUD -->
                <div class="flex gap-4">
                    <div class="glass-panel p-4 rounded-lg min-w-[140px] border-t-2 border-t-primary/50">
                        <p class="text-gray-400 text-xs font-mono uppercase tracking-wider mb-1">Session_Score</p>
                        <p id="session-score-display"
                            class="text-3xl font-bold tracking-tighter text-white tabular-nums drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">
                            0000</p>
                    </div>
                    <div class="glass-panel p-4 rounded-lg min-w-[140px] hidden sm:block">
                        <p class="text-gray-400 text-xs font-mono uppercase tracking-wider mb-1">High_Score</p>
                        <p id="high-score-display"
                            class="text-3xl font-bold tracking-tighter text-primary tabular-nums">0000</p>
                    </div>
                </div>
                <!-- Module Identifier - Initially Hidden, becomes Toggle Button -->
                <div id="hud-status-panel" class="glass-panel px-6 py-3 rounded-lg flex items-center gap-3 hidden">
                    <!-- Initial content removed -->
                </div>
            </header>
            <!-- Center Content: Game Menu / Empty State -->
            <div class="flex-1 flex items-center justify-center pointer-events-auto">
                <div class="relative max-w-lg w-full">
                    <!-- Decorative HUD corners -->
                    <div class="absolute -top-4 -left-4 size-8 border-t-2 border-l-2 border-primary"></div>
                    <div class="absolute -top-4 -right-4 size-8 border-t-2 border-r-2 border-primary"></div>
                    <div class="absolute -bottom-4 -left-4 size-8 border-b-2 border-l-2 border-primary"></div>
                    <div class="absolute -bottom-4 -right-4 size-8 border-b-2 border-r-2 border-primary"></div>
                    <!-- Main Modal Content -->
                    <div
                        class="glass-panel flex flex-col items-center gap-8 rounded-xl p-8 md:p-12 shadow-[0_0_50px_rgba(0,0,0,0.5)] bg-black/80">
                        <div class="flex flex-col items-center gap-2 text-center">
                            <div
                                class="size-16 rounded-full bg-primary/10 flex items-center justify-center mb-2 border border-primary/30 animate-pulse-glow">
                                <span class="material-symbols-outlined text-primary text-4xl">sports_esports</span>
                            </div>
                            <h1 class="text-white text-3xl md:text-4xl font-bold tracking-tight">準備就緒</h1>

                        </div>
                        <!-- Buttons -->
                        <div class="flex flex-col w-full gap-3">
                            <button id="init-btn"
                                class="group relative flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-14 px-8 bg-primary hover:bg-primary-glow transition-all duration-300 shadow-[0_0_20px_rgba(19,91,236,0.4)] hover:shadow-[0_0_30px_rgba(19,91,236,0.6)]">
                                <span
                                    class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></span>
                                <div class="relative flex items-center gap-3">
                                    <span id="init-icon" class="material-symbols-outlined">play_circle</span>
                                    <span id="init-text"
                                        class="text-white font-bold tracking-widest text-lg">開始遊戲</span>
                                </div>
                            </button>

                        </div>
                    </div>
                </div>
            </div>
            <!-- Bottom HUD: Health & Exit -->
            <footer
                class="flex flex-col-reverse md:flex-row justify-between items-end gap-6 w-full pointer-events-auto pb-4">
                <!-- Exit Button (Bottom Left) -->
                <a href="index.html"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-red-500/10 border border-red-500/30 hover:bg-red-500/20 text-red-400 text-xs font-bold tracking-wider uppercase transition-colors">
                    <span class="material-symbols-outlined text-lg">home</span>
                    <span>返回主頁</span>
                </a>
                <!-- Empty div for balance or additional controls (Bottom Right) -->
                <div class="hidden md:block w-[120px]"></div>
            </footer>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initBtn = document.getElementById('init-btn');
            const initText = document.getElementById('init-text');
            const initIcon = document.getElementById('init-icon');
            const staticBg = document.getElementById('static-bg');
            const arFeed = document.getElementById('ar-feed');
            const modal = document.querySelector('.glass-panel.flex-col.items-center');
            const sessionScoreDisplay = document.getElementById('session-score-display');
            const highScoreDisplay = document.getElementById('high-score-display');
            const gameContainer = document.getElementById('game-container');
            const bgMusic = document.getElementById('bg-music');

            // Attempt Autoplay on Load
            if (bgMusic) {
                bgMusic.volume = 0.4;
                bgMusic.play().catch(e => console.log("Autoplay waiting for interaction"));
            }

            // Remove original content storage as it's no longer needed
            // let originalHubContent = ...

            let currentStream = null;
            let sessionScore = 0;
            let highScore = parseInt(localStorage.getItem('cyber-race-highscore') || '0');
            let scoreInterval = null;
            let gameActive = false;
            let playerCar = null;
            let scene, camera, renderer;
            let targetX = 0;

            // Jump Mechanics
            let velocityY = 0;
            const gravity = 0.02;     // Increased gravity for snappier fall
            const jumpStrength = 0.5; // Increased jump strength for visibility
            const groundY = -1.5;
            let isJumping = false;

            // Enemy System
            let enemyTemplate = null;
            const enemies = [];
            const enemySpeed = 0.15;
            const spawnInterval = 2000; // ms
            let lastSpawnTime = 0;
            const laneWidth = 2.5; // Distance from center

            // Initialize High Score Display
            if (highScoreDisplay) {
                highScoreDisplay.textContent = highScore.toString().padStart(4, '0');
            }

            // Three.js Game Initialization
            const initGame = () => {
                if (gameActive) return;
                gameActive = true;

                gameContainer.classList.remove('hidden');

                scene = new THREE.Scene();
                // Transparent background to show AR feed

                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 2, 8);
                camera.lookAt(0, 0, 0);

                renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                gameContainer.appendChild(renderer.domElement);

                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(ambientLight);

                const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                dirLight.position.set(5, 10, 7);
                scene.add(dirLight);

                // Load Player Car Model
                const mtlLoader = new THREE.MTLLoader();
                const basePath = 'assets/model/Racing car/YELLOW STAR/';
                const fileName = 'tripo_convert_4cf89f3e-02ab-4ac0-a393-d3cfde42f770';

                mtlLoader.setPath(basePath);
                mtlLoader.load(fileName + '.mtl', (materials) => {
                    materials.preload();
                    const objLoader = new THREE.OBJLoader();
                    objLoader.setMaterials(materials);
                    objLoader.setPath(basePath);
                    objLoader.load(fileName + '.obj', (object) => {
                        playerCar = object;

                        // Scale and Position
                        const box = new THREE.Box3().setFromObject(object);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());

                        const maxDim = Math.max(size.x, size.y, size.z);
                        const scale = 2.0 / maxDim;
                        object.scale.set(scale, scale, scale);

                        // Center correction
                        object.position.x = 0;
                        object.position.y = groundY;
                        object.position.z = 0;

                        object.rotation.y = Math.PI / 2; // Rotated 180 degrees from previous (Face Right)

                        scene.add(object);
                    });
                });

                // Load Enemy Car Model (Template)
                const enemyMtlLoader = new THREE.MTLLoader();
                const enemyBasePath = 'assets/model/Racing car/KID RED/';
                const enemyFileName = 'tripo_convert_d5d254ed-1305-4cd0-ad1a-46e08b22a176';

                enemyMtlLoader.setPath(enemyBasePath);
                enemyMtlLoader.load(enemyFileName + '.mtl', (materials) => {
                    materials.preload();
                    const objLoader = new THREE.OBJLoader();
                    objLoader.setMaterials(materials);
                    objLoader.setPath(enemyBasePath);
                    objLoader.load(enemyFileName + '.obj', (object) => {
                        // Scale template
                        const box = new THREE.Box3().setFromObject(object);
                        const size = box.getSize(new THREE.Vector3());
                        const maxDim = Math.max(size.x, size.y, size.z);
                        const scale = 2.0 / maxDim;
                        object.scale.set(scale, scale, scale);
                        object.rotation.y = -Math.PI / 2; // Rotated 180 degrees from previous (Face Left)

                        enemyTemplate = object;
                    });
                });

                // Input Handling
                const handleInput = (x) => {
                    // Map screen X to world X (approximate range -4 to 4)
                    const normalizedX = (x / window.innerWidth) * 2 - 1; // -1 to 1
                    targetX = normalizedX * 5; // Invert logic if needed, scaling to scene width
                };

                const jump = () => {
                    if (!isJumping) {
                        velocityY = jumpStrength;
                        isJumping = true;
                    }
                };

                document.addEventListener('mousemove', (e) => handleInput(e.clientX));
                document.addEventListener('touchmove', (e) => {
                    if (e.touches.length > 0) handleInput(e.touches[0].clientX);
                }, { passive: true });

                document.addEventListener('click', jump);
                document.addEventListener('touchstart', (e) => {
                    // Prevent default to avoid double firing if needed, but for game 'click' usually works too.
                    // Separate listener for better responsiveness.
                    jump();
                }, { passive: true });

                // Spawn Enemy Function
                const spawnEnemy = (time) => {
                    if (!enemyTemplate || time - lastSpawnTime < spawnInterval) return;

                    const enemy = enemyTemplate.clone();
                    // Random Position: Left or Right
                    const side = Math.random() > 0.5 ? 1 : -1;
                    enemy.position.set(side * laneWidth, groundY, -50); // Start far away

                    scene.add(enemy);
                    enemies.push({ mesh: enemy, passed: false });
                    lastSpawnTime = time;
                };

                // Collision Detection
                const checkCollision = () => {
                    if (!playerCar) return;

                    const playerBox = new THREE.Box3().setFromObject(playerCar);
                    // Shrink box slightly for forgiveness, but not too much
                    playerBox.expandByScalar(-0.15);

                    for (let i = 0; i < enemies.length; i++) {
                        const enemy = enemies[i].mesh;
                        const enemyBox = new THREE.Box3().setFromObject(enemy);
                        enemyBox.expandByScalar(-0.15);

                        if (playerBox.intersectsBox(enemyBox)) {
                            gameOver();
                            return true;
                        }
                    }
                    return false;
                };

                const gameOver = () => {
                    gameActive = false;
                    if (sessionScore > highScore) {
                        highScore = sessionScore;
                        localStorage.setItem('cyber-race-highscore', highScore.toString());
                        if (highScoreDisplay) highScoreDisplay.textContent = highScore.toString().padStart(4, '0');
                    }

                    // Show Game Over UI
                    if (modal && modal.parentElement) {
                        const modalContainer = modal.parentElement;
                        const title = modal.querySelector('h1');
                        const btnText = document.getElementById('init-text');
                        const btnIcon = document.getElementById('init-icon');

                        if (title) {
                            title.innerHTML = `GAME OVER<br><span class="text-2xl text-white mt-2 block">SCORE: ${sessionScore}</span>`;
                            title.classList.add('text-red-500');
                        }

                        if (btnText) btnText.textContent = "TRY AGAIN";
                        if (btnIcon) btnIcon.textContent = "replay";

                        modalContainer.classList.remove('hidden');

                        // Replace button to avoid old listeners and ensure reload
                        const newBtn = initBtn.cloneNode(true);
                        initBtn.parentNode.replaceChild(newBtn, initBtn);
                        newBtn.addEventListener('click', () => location.reload());
                    } else {
                        // Fallback
                        alert("遊戲結束！ 最終得分: " + sessionScore);
                        location.reload();
                    }
                };

                // Animation Loop
                const animate = (time) => {
                    if (!gameActive) return;
                    requestAnimationFrame(animate);

                    if (playerCar) {
                        // Smooth movement towards target
                        playerCar.position.x += (targetX - playerCar.position.x) * 0.1;

                        // Tilt effect
                        playerCar.rotation.z = (playerCar.position.x - targetX) * 0.1;

                        // Jump Physics
                        velocityY -= gravity;
                        playerCar.position.y += velocityY;

                        // Ground Collision
                        if (playerCar.position.y <= groundY) {
                            playerCar.position.y = groundY;
                            velocityY = 0;
                            isJumping = false;
                        }
                    }

                    // Enemy Logic
                    spawnEnemy(time);

                    for (let i = enemies.length - 1; i >= 0; i--) {
                        const enemyData = enemies[i];
                        const enemy = enemyData.mesh;

                        enemy.position.z += enemySpeed; // Move towards player

                        // Scoring
                        if (!enemyData.passed && enemy.position.z > playerCar.position.z) {
                            enemyData.passed = true;
                            sessionScore += 20;
                            if (sessionScoreDisplay) sessionScoreDisplay.textContent = sessionScore.toString().padStart(4, '0');
                        }

                        // Cleanup
                        if (enemy.position.z > 10) {
                            scene.remove(enemy);
                            enemies.splice(i, 1);
                        }
                    }

                    checkCollision();

                    renderer.render(scene, camera);
                };
                animate(0);

                // Resize handler
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
            };

            // Function to update score
            const startScore = () => {
                // Reset score for real game
                sessionScore = 0;
                if (sessionScoreDisplay) sessionScoreDisplay.textContent = "0000";
            };

            const stopScore = () => {
                if (scoreInterval) clearInterval(scoreInterval);
            };

            // Function to start AR
            const startAR = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" }
                    });
                    currentStream = stream;
                    arFeed.srcObject = stream;

                    arFeed.onloadedmetadata = () => {
                        arFeed.play();

                        // Visual transition
                        staticBg.classList.add('opacity-0', 'transition-opacity', 'duration-1000');
                        setTimeout(() => {
                            staticBg.classList.add('hidden');
                            arFeed.classList.remove('hidden');
                        }, 500);

                        // Start Score Simulation
                        startScore();
                        // Start the Game Loop
                        initGame();

                        // Update HUD to Close Camera
                        if (hudStatusPanel) {
                            hudStatusPanel.classList.remove('hidden'); // Make visible
                            hudStatusPanel.classList.add('cursor-pointer', 'hover:bg-red-500/20', 'transition-colors');
                            hudStatusPanel.innerHTML = `
                                <span class="material-symbols-outlined text-red-500">videocam_off</span>
                                <div>
                                    <h2 class="text-sm font-bold tracking-widest text-red-500">關閉鏡頭</h2>
                                </div>
                            `;
                            // Remove any previous open handlers just in case
                            hudStatusPanel.removeEventListener('click', startAR);
                            // Add close handler
                            hudStatusPanel.addEventListener('click', stopAR, { once: true });
                        }
                    };
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    if (initText) initText.textContent = "CAMERA ACCESS DENIED";
                    alert("Could not access camera for AR mode.");

                    // Fallback to game without AR if camera fails
                    startScore();
                    initGame();
                    staticBg.classList.add('hidden'); // Hide static BG anyway or keep it? Maybe keep it for non-AR fall back
                    // Actually, if AR fails, we might want to keep static BG but still run game.
                    // For now simple fallback:
                    gameContainer.classList.remove('hidden');
                }
            };

            // Function to stop AR and show Open Camera button
            const stopAR = () => {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }

                // Stop Score Simulation -> REMOVED: Game should continue running
                // stopScore();

                // Hide video, show static bg
                arFeed.classList.add('hidden');
                staticBg.classList.remove('hidden');
                staticBg.classList.remove('opacity-0');

                // Update HUD to Open Camera
                if (hudStatusPanel) {
                    hudStatusPanel.innerHTML = `
                        <span class="material-symbols-outlined text-primary">videocam</span>
                        <div>
                            <h2 class="text-sm font-bold tracking-widest text-primary">開啟鏡頭</h2>
                        </div>
                    `;
                    // Add open handler
                    hudStatusPanel.addEventListener('click', startAR, { once: true });
                }
            };

            if (initBtn) {
                initBtn.addEventListener('click', async () => {
                    if (bgMusic && bgMusic.paused) {
                        bgMusic.play();
                    }

                    if (initText) initText.textContent = "INITIALIZING CORE...";
                    if (initIcon) initIcon.classList.add('animate-spin');

                    // Initial start
                    await startAR();

                    // Additional one-time UI updates for the modal/init button
                    if (currentStream || gameActive) {
                        if (initText) initText.textContent = "SYSTEM ONLINE";
                        if (initIcon) {
                            initIcon.classList.remove('animate-spin');
                            initIcon.textContent = "sports_esports";
                        }
                        initBtn.classList.replace('bg-primary', 'bg-red-600');
                        initBtn.classList.replace('hover:bg-primary-glow', 'hover:bg-red-500');

                        document.body.classList.add('ar-active');

                        setTimeout(() => {
                            if (modal) modal.parentElement.classList.add('hidden');
                        }, 1000);
                    }
                });
            }
        });
    </script>
</body>

</html>